{% extends "base.html" %}

{% block body %}
<div>
    <h1>
        Chat with {{ to }}
    </h1>
</div>
<div class="flex-hor gap-10">
    <input id="msg-input" required minlength="3" class="input pad-10 rad-10 bb" type="text" placeholder="message" />
    <button style="pointer-events: none;" id="btn" class="btn pad-10 rad-10 bb" onclick="send()">Send</button>
</div>
<div id="messages" class="flex-ver bb pad-10 gap-10 rad-10 bor-5" style="max-width:300px;">
    {% if messages %}
        {% for msg in messages %}
        {% if msg.author.name == user.name %}
        <div class="sent-container">
            <div class="sent">
                {{ msg.text }}
            </div>
        </div>
        {% else %}
        <div class="received-container">
            <div class="received">
                {{ msg.text }}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    {% else %}
    <div id="conversation" style="font-size:large; color:var(--darkgrey);">
        START A CONVERSATION
    </div>
    {% endif %}
</div>

<script type="text/javascript">
    const ws = new WebSocket(`ws://${location.host}/ws`)
    const input = document.querySelector("#msg-input")
    const btn = document.querySelector("#btn")

    ws.onmessage = event => {
        const container = document.createElement("div")
        container.classList.add("received-container")
        const div = document.createElement("div")
        div.classList.add("received")
        div.classList.add("ani")
        div.textContent = `${event.data}`
        container.append(div)
        document.getElementById("messages").appendChild(container)
    }

    input.oninput = () => {
        if (input.value.length < 3) {
            btn.style.pointerEvents = "none"
        } else {
            btn.style.pointerEvents = "all"
        }
    }

    function send() {
        const msg = input.value
        ws.send(JSON.stringify({
            "msg": msg,
            "to": {{ to | tojson }}
        }))
        try {
            document.querySelector("#conversation").style.display = "none"
        } catch() {}
        const container = document.createElement("div")
        container.classList.add("sent-container")
        const div = document.createElement("div")
        div.classList.add("sent")
        div.textContent = `${msg}`
        container.append(div)
        document.getElementById("messages").appendChild(container)
    }
</script>
{% endblock %}